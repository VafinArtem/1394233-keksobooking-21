(()=>{"use strict";(()=>{const e={ESCAPE:"Escape",ENTER:"Enter"};window.util={getRandomArrElement:e=>e[Math.floor(Math.random()*e.length)],getRandomInt:(e,t)=>Math.floor(Math.random()*(t-e+1))+e,getDeclension:(e,t)=>t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]],getRandomLenghtArr:e=>e.slice(0,window.util.getRandomInt(0,e.length)),onPopupEscPress:t=>{t.key===e.ESCAPE&&(t.preventDefault(),window.map.removeActiveCard())},onPopupMessageEscPress:t=>{t.key===e.ESCAPE&&(t.preventDefault(),window.reset.removeMessageElement())},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},MouseButtons:{MAIN:0},KeyboardKeys:e}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0);return o.style.left=e.location.x+"px",o.style.top=e.location.y+"px",o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.pin={mapNode:e,mapPinsNode:e.querySelector(".map__pins"),createPinsNodeFragment:e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(o(e[n]));return t},remove:()=>{let e=window.pin.mapPinsNode.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.parentNode.removeChild(t)}}})(),(()=>{const e=window.pin.mapNode.querySelector(".map__pin--main"),t={Y:e.style.top,X:e.style.left};window.map={mapPinMain:e,defaultMainPinCoordinates:t,initPinsScreen:e=>{const t=window.pin.createPinsNodeFragment(e);window.pin.mapPinsNode.appendChild(t)},removeActiveCard:()=>{const e=window.pin.mapNode.querySelector(".map__card");e&&(e.parentNode.removeChild(e),document.removeEventListener("keydown",window.util.onPopupEscPress))}}})(),(()=>{const e=window.pin.mapNode.querySelector(".map__filters-container"),t=e.querySelector(".map__filters");let o=!1;const n=()=>{o=!o,Array.from(window.form.formNode.children).forEach((e=>{e.disabled=o,e.classList.toggle("disable-cursor",o)})),Array.from(t.children).forEach((e=>{e.disabled=o,e.classList.toggle("disable-cursor",o)}))},i=e=>{const o=e;window.pin.mapNode.classList.remove("map--faded"),window.form.formNode.classList.remove("ad-form--disabled"),n(),window.form.passAddressInput(window.move.MainPinSize.pin.WIDTH,window.move.MainPinSize.pin.HEIGHT),window.filter.updateSimillarPins(o);const i=window.util.debounce((()=>{window.filter.updateSimillarPins(o)}));t.addEventListener("change",i)},r=e=>{e.button===window.util.MouseButtons.MAIN&&(e.preventDefault(),window.backend.load(i),window.map.mapPinMain.removeEventListener("keydown",a))},a=e=>{e.key===window.util.KeyboardKeys.ENTER&&(e.preventDefault(),window.backend.load(i),window.map.mapPinMain.removeEventListener("mousedown",r))};window.activate={onPinMainMousedownPress:r,onPinMainEnterPress:a,toggleDisabledOnFormNodes:n,mapFiltersNode:e,formFiltersNode:t}})(),(()=>{const e=Array.from(window.activate.formFiltersNode.features),t=(e,t,o,n)=>"any"===window.activate.formFiltersNode[e].value?o:parseInt(n.offer[t],10)===parseInt(window.activate.formFiltersNode[e].value,10),o=(e,t)=>"any"===window.activate.formFiltersNode["housing-type"].value?t:e.offer.type===window.activate.formFiltersNode["housing-type"].value,n=(e,o,n)=>t("housing-rooms","rooms",n,e),i=(e,o,n)=>t("housing-guests","guests",n,e),r=(e,t,o)=>{switch(window.activate.formFiltersNode["housing-price"].value){case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return o}},a=function(t){return!e.some((function(e){return e.checked&&!t.offer.features.includes(e.value)}))};window.filter={updateSimillarPins:e=>{const t=e.filter(o).filter(n).filter(i).filter(r).filter(a).slice(0,5);window.map.removeActiveCard(),window.pin.remove(),window.map.initPinsScreen(t),window.card.addCardNode(t)}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o=document.querySelector("#error").content.querySelector(".error"),n=e=>{const t=o.cloneNode(!0);t.querySelector(".error__message").textContent=e,window.reset.mainNode.appendChild(t),document.addEventListener("keydown",window.util.onPopupMessageEscPress,{once:!0}),t.addEventListener("click",window.reset.removeMessageElement,{once:!0})},i=(e,t,o,i)=>{let r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?o(r.response):n(`При обращению к серверу произошла ошибка. Статус ответа: ${r.status} ${r.statusText}. Попробуйте перезагрузить страницу`)})),r.addEventListener("error",(()=>{n(`Произошла ошибка соединения. Статус ответа: ${r.status} ${r.statusText}. Попробуйте перезагрузить страницу`)})),r.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${r.timeout}мс. Статус ответа: ${r.status} ${r.statusText}. Попробуйте перезагрузить страницу`)})),r.open(e,t),r.timeout=1e4,r.send("GET"===e?"":i)};window.backend={load:t=>{i("GET",e,t)},upload:(e,o)=>{i("POST",t,o,e)}}})(),(()=>{const e={wifi:"popup__feature--wifi",dishwasher:"popup__feature--dishwasher",parking:"popup__feature--parking",washer:"popup__feature--washer",elevator:"popup__feature--elevator",conditioner:"popup__feature--conditioner"},t={flat:"Квартира",bungalow:"Бунгало",palace:"Замок",house:"Дом"},o=document.querySelector("#card").content.querySelector(".map__card"),n=n=>{const i=document.createDocumentFragment();return i.appendChild((n=>{const i=o.cloneNode(!0);if(n.offer.title.length&&(i.querySelector(".popup__title").classList.remove("hidden"),i.querySelector(".popup__title").textContent=n.offer.title),n.offer.address.length&&(i.querySelector(".popup__text--address").classList.remove("hidden"),i.querySelector(".popup__text--address").textContent=n.offer.address),n.offer.price&&(i.querySelector(".popup__text--price").classList.remove("hidden"),i.querySelector(".popup__text--price").textContent=new Intl.NumberFormat("ru-RU").format(n.offer.price)+" ₽/ночь"),n.offer.type.length&&(i.querySelector(".popup__type").classList.remove("hidden"),i.querySelector(".popup__type").textContent=t[n.offer.type]),i.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} ${window.util.getDeclension(n.offer.rooms,["комната","комнаты","комнат"])} ${n.offer.guests>0?`для ${n.offer.guests} ${window.util.getDeclension(n.offer.guests,["гостя","гостей","гостей"])}`:"не для гостей"}`,i.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout} `,n.offer.description.length&&(i.querySelector(".popup__description").classList.remove("hidden"),i.querySelector(".popup__description").textContent=n.offer.description),n.author.avatar.length&&(i.querySelector(".popup__avatar").classList.remove("hidden"),i.querySelector(".popup__avatar").src=n.author.avatar),n.offer.features.length){i.querySelector(".popup__features").classList.remove("hidden");const t=i.querySelectorAll(".popup__feature");for(let o=0;o<t.length;o++)for(let i=0;i<n.offer.features.length;i++)if(t[o].classList.contains(e[n.offer.features[i]])){t[o].classList.remove("hidden");break}}if(n.offer.photos.length){i.querySelector(".popup__photos").classList.remove("hidden");let e=i.querySelector(".popup__photo");if(e.src=n.offer.photos[0],n.offer.photos.length>1){const t=document.createDocumentFragment();for(let o=1;o<n.offer.photos.length;o++)t.appendChild(e.cloneNode(!0)).src=n.offer.photos[o];e.parentElement.appendChild(t)}}return i})(n)),i};window.card={createСardFragment:n,addCardNode:e=>{window.pin.mapPinsNode.querySelectorAll(".map__pin:not(.map__pin--main)").forEach(((t,o)=>{t.addEventListener("click",(()=>{window.map.removeActiveCard();const t=n(e[o]);t.querySelector(".popup__close").addEventListener("click",window.map.removeActiveCard),document.addEventListener("keydown",window.util.onPopupEscPress),window.pin.mapNode.insertBefore(t,window.activate.mapFiltersNode)}))}))}}})(),(()=>{const e={circle:{WIDTH:62,HEIGHT:62},pin:{WIDTH:62,HEIGHT:84}},t=630,o=130,n=window.pin.mapNode.offsetWidth-e.pin.WIDTH/2,i=-e.pin.WIDTH/2;window.map.mapPinMain.addEventListener("mousedown",(r=>{if(r.button===window.util.MouseButtons.MAIN){r.preventDefault();let a={x:r.clientX,y:r.clientY};const s=r=>{r.preventDefault();const s=a.x-r.clientX,d=a.y-r.clientY,p=window.map.mapPinMain.offsetLeft-s,c=window.map.mapPinMain.offsetTop-d;a={x:r.clientX,y:r.clientY},p>=i&&p<=n&&(window.map.mapPinMain.style.left=p+"px"),c>=o&&c<=t&&(window.map.mapPinMain.style.top=c+"px"),window.form.passAddressInput(e.pin.WIDTH,e.pin.HEIGHT)},d=e=>{e.preventDefault(),window.pin.mapNode.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)};window.pin.mapNode.addEventListener("mousemove",s),document.addEventListener("mouseup",d)}})),window.move={MainPinSize:e}})(),window.reset={page:()=>{window.pin.mapNode.classList.add("map--faded"),window.form.formNode.classList.add("ad-form--disabled"),window.activate.toggleDisabledOnFormNodes(),window.pin.remove(),window.form.formNode.reset(),window.activate.formFiltersNode.reset(),window.map.mapPinMain.style.left=window.map.defaultMainPinCoordinates.X,window.map.mapPinMain.style.top=window.map.defaultMainPinCoordinates.Y,window.form.passAddressInput(window.move.MainPinSize.circle.WIDTH,window.move.MainPinSize.circle.HEIGHT),window.map.removeActiveCard(),window.map.mapPinMain.addEventListener("mousedown",window.activate.onPinMainMousedownPress,{once:!0}),window.map.mapPinMain.addEventListener("keydown",window.activate.onPinMainEnterPress,{once:!0}),window.scrollTo({top:0,behavior:"smooth"})}},(()=>{const e={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},t={palace:1e4,house:5e3,flat:1e3,bungalow:0},o=document.querySelector(".ad-form"),n=o.querySelector(".ad-form__reset"),i=document.querySelector("main"),r=document.querySelector("#success").content.querySelector(".success"),a=()=>{const e=i.querySelector(".success, .error");e&&(e.parentNode.removeChild(e),document.removeEventListener("keydown",window.util.onPopupMessageEscPress))};o.addEventListener("change",(n=>{switch(n.target){case o.title:(()=>{const e=o.title.value.length;e<30?o.title.setCustomValidity(`Ещё ${30-e} симв.`):e>100?o.title.setCustomValidity(`Удалите лишние ${e-100} симв.`):o.title.setCustomValidity(""),o.title.reportValidity()})();break;case o.rooms:case o.capacity:o.capacity.setCustomValidity(e[o.rooms.value].includes(o.capacity.value)?"":"Вы не можете выбрать данное количество гостей"),o.capacity.reportValidity();break;case o.timein:case o.timeout:(e=>{e.target===o.timein?o.timeout.value=o.timein.value:o.timein.value=o.timeout.value})(n);break;case o.type:o.price.min=t[o.type.value],o.price.placeholder=t[o.type.value]}})),o.addEventListener("submit",(e=>{window.backend.upload(new FormData(o),window.reset.page),(()=>{const e=r.cloneNode(!0);i.appendChild(e),document.addEventListener("keydown",window.util.onPopupMessageEscPress,{once:!0}),e.addEventListener("click",a,{once:!0})})(),e.preventDefault()})),n.addEventListener("click",(()=>{window.reset.page()})),window.form={formNode:o,passAddressInput:(e,t)=>{o.address.value=`${(e=>parseInt(window.map.mapPinMain.style.left,10)+e/2)(e)}, ${(e=>e===window.move.MainPinSize.pin.HEIGHT?parseInt(window.map.mapPinMain.style.top,10):parseInt(window.map.mapPinMain.style.top,10)-e/2)(t)}`}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=window.form.formNode.querySelector(".ad-form-header__input"),o=window.form.formNode.querySelector(".ad-form-header__preview img");t.addEventListener("change",(()=>{const n=t.files[0],i=n.name.toLowerCase();if(e.some((function(e){return i.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}}))})(),window.activate.toggleDisabledOnFormNodes(),window.form.passAddressInput(window.move.MainPinSize.circle.WIDTH,window.move.MainPinSize.circle.HEIGHT),window.map.mapPinMain.addEventListener("mousedown",window.activate.onPinMainMousedownPress,{once:!0}),window.map.mapPinMain.addEventListener("keydown",window.activate.onPinMainEnterPress,{once:!0})})();